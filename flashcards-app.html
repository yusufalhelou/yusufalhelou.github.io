---

---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Flashcards</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styles for 3D flip effect */
        .perspective {
            perspective: 1000px;
        }
        .style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        /* Basic scrollbar styling for filter panels */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1; /* Light gray track */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Gray thumb */
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* Darker gray on hover */
        }
        /* Dark mode scrollbar */
        .dark .overflow-y-auto::-webkit-scrollbar-track {
            background: #374151; /* Darker gray track */
        }
        .dark .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #4b5563; /* Dark gray thumb */
        }
        .dark .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4">
    <div id="app" class="container mx-auto max-w-7xl font-inter">
        <h1 class="text-4xl font-extrabold text-center mb-8 text-indigo-700 dark:text-indigo-400">
            ðŸ’Š Flashcard Study App
        </h1>

        <div class="flex flex-col lg:flex-row gap-8 mb-8">
            <!-- Filter by Pharmacology Panel -->
            <div id="pharmacology-filter-panel" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex-1 min-w-[300px]">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Filter by Pharmacology</h2>
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="select-all-pharmacology" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                    <label for="select-all-pharmacology" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 cursor-pointer">Select All</label>
                </div>
                <div id="pharmacology-options" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Pharmacology checkboxes will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Filter by Route Panel -->
            <div id="route-filter-panel" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex-1 min-w-[300px]">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Filter by Route</h2>
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="select-all-route" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                    <label for="select-all-route" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 cursor-pointer">Select All</label>
                </div>
                <div id="route-options" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Route checkboxes will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Card Customization Panel -->
            <div id="card-customization-panel" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex-1 min-w-[300px]">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Card Content Options</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4">Select additional details to show on the front of the card:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="display-company" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                        <label for="display-company" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 capitalize cursor-pointer">Company</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="display-pharmacology" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                        <label for="display-pharmacology" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 capitalize cursor-pointer">Pharmacology</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="display-route" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                        <label for="display-route" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 capitalize cursor-pointer">Route</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="display-price" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500" />
                        <label for="display-price" class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-200 capitalize cursor-pointer">Price</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flashcard Display Area -->
        <div class="flex flex-col items-center justify-center gap-6">
            <div id="flashcard-container" class="relative w-full max-w-md h-[400px] perspective cursor-pointer transform transition-transform duration-500 rounded-xl shadow-2xl hidden">
                <!-- Flashcard content will be injected here by JavaScript -->
            </div>
            <p id="no-cards-message" class="text-xl text-red-500 hidden">No cards match your current filters. Please adjust your selections.</p>
            <div id="navigation-buttons" class="flex gap-4 hidden">
                <button id="prev-card" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:-translate-y-0.5">
                    Previous
                </button>
                <button id="next-card" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:-translate-y-0.5">
                    Next
                </button>
            </div>
            <p id="card-count" class="text-sm text-gray-600 dark:text-gray-400 mt-2 hidden"></p>
        </div>
    </div>

    <script>
        // Global state variables
        let allDrugs = [];
        let filteredDrugs = [];
        let uniquePharmacologies = [];
        let uniqueRoutes = [];
        let selectedPharmacologies = {};
        let selectedRoutes = {};
        let cardDisplayOptions = {
            company: false,
            pharmacology: false,
            route: false,
            price: false,
        };
        let currentCardIndex = 0;
        let isFlipped = false;
        let loadingImage = false;
        let iframeSrc = '';
        let showIframe = false;
        let currentCard = null;

        // --- Jekyll Injected Data ---
        // This is where Jekyll will inject your Drugs.json content
        const jekyllDrugsData = {{ site.data.drugs | jsonify }};

        // --- Utility Functions ---

        // Function to transform raw data into a more usable format
        function transformDrugData(rawData) {
            if (!rawData || !rawData.objects || !rawData.rows || !rawData.rows.persons) {
                console.error("Invalid raw drug data structure:", rawData);
                return [];
            }
            const columns = rawData.objects[0].columns.map(col => col.name);
            return rawData.rows.persons.map(row => {
                const drug = {};
                columns.forEach((colName, index) => {
                    drug[colName] = row[index];
                });
                return drug;
            });
        }

        // --- Render Functions ---

        function renderPharmacologyFilters() {
            const pharmOptionsDiv = document.getElementById('pharmacology-options');
            pharmOptionsDiv.innerHTML = ''; // Clear previous options
            const selectAllPharmCheckbox = document.getElementById('select-all-pharmacology');
            const allSelectedPharm = uniquePharmacologies.every(p => selectedPharmacologies[p]);
            selectAllPharmCheckbox.checked = allSelectedPharm;
            selectAllPharmCheckbox.nextElementSibling.textContent = allSelectedPharm ? "Deselect All" : "Select All";


            uniquePharmacologies.forEach(pharmacology => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="pharm-${pharmacology}" data-pharm="${pharmacology}"
                           class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500"
                           ${selectedPharmacologies[pharmacology] ? 'checked' : ''}>
                    <label for="pharm-${pharmacology}" class="ml-2 text-base text-gray-700 dark:text-gray-200 cursor-pointer">
                        ${pharmacology}
                    </label>
                `;
                pharmOptionsDiv.appendChild(div);
            });
            addPharmacologyFilterListeners();
        }

        function renderRouteFilters() {
            const routeOptionsDiv = document.getElementById('route-options');
            routeOptionsDiv.innerHTML = ''; // Clear previous options
            const selectAllRouteCheckbox = document.getElementById('select-all-route');
            const allSelectedRoute = uniqueRoutes.every(r => selectedRoutes[r]);
            selectAllRouteCheckbox.checked = allSelectedRoute;
            selectAllRouteCheckbox.nextElementSibling.textContent = allSelectedRoute ? "Deselect All" : "Select All";

            uniqueRoutes.forEach(route => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="route-${route}" data-route="${route}"
                           class="form-checkbox h-5 w-5 text-indigo-600 rounded-md cursor-pointer transition duration-150 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500"
                           ${selectedRoutes[route] ? 'checked' : ''}>
                    <label for="route-${route}" class="ml-2 text-base text-gray-700 dark:text-gray-200 cursor-pointer">
                        ${route}
                    </label>
                `;
                routeOptionsDiv.appendChild(div);
            });
            addRouteFilterListeners();
        }

        function renderCard() {
            const cardContainer = document.getElementById('flashcard-container');
            const noCardsMessage = document.getElementById('no-cards-message');
            const navigationButtons = document.getElementById('navigation-buttons');
            const cardCount = document.getElementById('card-count');

            isFlipped = false; // Reset flip state
            loadingImage = false;
            showIframe = false;

            if (filteredDrugs.length === 0) {
                cardContainer.classList.add('hidden');
                noCardsMessage.classList.remove('hidden');
                navigationButtons.classList.add('hidden');
                cardCount.classList.add('hidden');
                return;
            }

            noCardsMessage.classList.add('hidden');
            cardContainer.classList.remove('hidden');
            navigationButtons.classList.remove('hidden');
            cardCount.classList.remove('hidden');

            currentCard = filteredDrugs[currentCardIndex];

            const cardHtml = `
                <div class="relative w-full h-full style-3d preserve-3d ${isFlipped ? 'rotate-y-180' : ''}">
                    <!-- Front Face -->
                    <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 rounded-xl flex flex-col justify-center items-center text-center shadow-lg transform transition-all duration-300 hover:scale-105">
                        <h3 class="text-3xl font-bold mb-2">${currentCard.FirstName || 'N/A'}</h3>
                        <p class="text-xl italic mb-4">${currentCard.LastName || 'N/A'}</p>
                        <div class="space-y-2 text-lg">
                            ${cardDisplayOptions.company ? `<p><span class="font-semibold">Company:</span> ${currentCard.Company || 'N/A'}</p>` : ''}
                            ${cardDisplayOptions.pharmacology ? `<p><span class="font-semibold">Pharmacology:</span> ${currentCard.Pharmacology || 'N/A'}</p>` : ''}
                            ${cardDisplayOptions.route ? `<p><span class="font-semibold">Route:</span> ${currentCard.Route || 'N/A'}</p>` : ''}
                            ${cardDisplayOptions.price ? `<p><span class="font-semibold">Price:</span> $${currentCard.price || 'N/A'}</p>` : ''}
                        </div>
                        <p class="absolute bottom-4 right-4 text-sm opacity-80">Click to flip!</p>
                    </div>

                    <!-- Back Face -->
                    <div class="absolute w-full h-full backface-hidden bg-white dark:bg-gray-800 rounded-xl flex flex-col justify-center items-center p-4 text-gray-900 dark:text-gray-100 rotate-y-180 shadow-lg transform transition-all duration-300 hover:scale-105">
                        <div id="image-search-content" class="flex flex-col items-center justify-center h-full w-full">
                            ${loadingImage ? `
                                <div class="flex flex-col items-center justify-center h-full">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
                                    <p class="text-lg">Searching for image...</p>
                                </div>
                            ` : showIframe && iframeSrc ? `
                                <iframe src="${iframeSrc}" title="Image search for ${currentCard.FirstName}"
                                        class="w-full h-full rounded-lg border-0 shadow-inner"
                                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                                        onerror="this.style.display='none'; document.getElementById('image-error-fallback').classList.remove('hidden');"
                                ></iframe>
                                <div id="image-error-fallback" class="hidden flex flex-col items-center justify-center h-full text-center p-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                                      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="text-xl text-red-600 dark:text-red-300">
                                        Could not load image search.
                                    </p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                                        (Browser security policies might be blocking Google Search in an iframe.)
                                    </p>
                                </div>
                            ` : `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                                  <path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="text-xl text-gray-600 dark:text-gray-300">
                                    Image search will appear here for "${currentCard.FirstName || 'this item'}".
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                                    (Note: Google Search in an iframe might be restricted by browser security policies.)
                                </p>
                            `}
                        </div>
                        <p class="absolute bottom-4 right-4 text-sm opacity-80">Click to flip back!</p>
                    </div>
                </div>
            `;
            cardContainer.innerHTML = cardHtml;
            cardContainer.querySelector('.relative.style-3d').classList.toggle('rotate-y-180', isFlipped);
            document.getElementById('card-count').textContent = `Card ${currentCardIndex + 1} of ${filteredDrugs.length}`;
        }


        // --- Event Listeners and Handlers ---

        function addPharmacologyFilterListeners() {
            document.querySelectorAll('#pharmacology-options input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (event) => {
                    const pharm = event.target.dataset.pharm;
                    selectedPharmacologies[pharm] = event.target.checked;
                    applyFilters();
                    renderPharmacologyFilters(); // Re-render to update 'Select All' state
                };
            });
            document.getElementById('select-all-pharmacology').onchange = (event) => {
                const checked = event.target.checked;
                uniquePharmacologies.forEach(p => {
                    selectedPharmacologies[p] = checked;
                });
                applyFilters();
                renderPharmacologyFilters();
            };
        }

        function addRouteFilterListeners() {
            document.querySelectorAll('#route-options input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (event) => {
                    const route = event.target.dataset.route;
                    selectedRoutes[route] = event.target.checked;
                    applyFilters();
                    renderRouteFilters(); // Re-render to update 'Select All' state
                };
            });
            document.getElementById('select-all-route').onchange = (event) => {
                const checked = event.target.checked;
                uniqueRoutes.forEach(r => {
                    selectedRoutes[r] = checked;
                });
                applyFilters();
                renderRouteFilters();
            };
        }

        function addCardDisplayOptionListeners() {
            document.querySelectorAll('#card-customization-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (event) => {
                    const option = event.target.id.replace('display-', '');
                    cardDisplayOptions[option] = event.target.checked;
                    renderCard(); // Re-render card immediately to show/hide options
                };
            });
        }

        function addNavigationListeners() {
            document.getElementById('prev-card').onclick = () => {
                currentCardIndex = (currentCardIndex - 1 + filteredDrugs.length) % filteredDrugs.length;
                renderCard();
            };
            document.getElementById('next-card').onclick = () => {
                currentCardIndex = (currentCardIndex + 1) % filteredDrugs.length;
                renderCard();
            };
            document.getElementById('flashcard-container').onclick = () => {
                isFlipped = !isFlipped;
                const cardInner = document.querySelector('#flashcard-container .relative.style-3d');
                cardInner.classList.toggle('rotate-y-180', isFlipped);

                if (isFlipped && currentCard && currentCard.FirstName) {
                    loadingImage = true;
                    showIframe = false;
                    renderCard(); // Render to show loading spinner

                    const query = encodeURIComponent(currentCard.FirstName + " drug"); // Added ' drug' for better search results
                    iframeSrc = `https://www.google.com/search?tbm=isch&q=${query}&igu=1`;

                    // Simulate loading and then show the iframe.
                    // Actual iframe loading can be tricky to detect cross-origin.
                    setTimeout(() => {
                        loadingImage = false;
                        showIframe = true;
                        renderCard(); // Render to show iframe
                    }, 1500); // Simulate load time
                } else {
                    showIframe = false;
                    loadingImage = false;
                    renderCard(); // Render to hide iframe/loading if flipped back
                }
            };
        }

        // --- Core Logic ---

        function applyFilters() {
            filteredDrugs = allDrugs.filter(drug => {
                const pharmMatch = selectedPharmacologies[drug.Pharmacology] || false;
                const routeMatch = selectedRoutes[drug.Route] || false;
                return pharmMatch && routeMatch;
            });
            currentCardIndex = 0; // Reset to first card when filters change
            renderCard();
        }

        async function initializeApp() {
            try {
                // Use the Jekyll-injected data directly
                allDrugs = transformDrugData(jekyllDrugsData);

                // Extract unique pharmacologies and routes
                const pharmSet = new Set();
                const routeSet = new Set();
                allDrugs.forEach(drug => {
                    if (drug.Pharmacology) pharmSet.add(drug.Pharmacology);
                    if (drug.Route) routeSet.add(drug.Route);
                });
                uniquePharmacologies = Array.from(pharmSet).sort();
                uniqueRoutes = Array.from(routeSet).sort();

                // Initialize all filters as selected by default
                uniquePharmacologies.forEach(p => selectedPharmacologies[p] = true);
                uniqueRoutes.forEach(r => selectedRoutes[r] = true);

                renderPharmacologyFilters();
                renderRouteFilters();
                addCardDisplayOptionListeners();
                addNavigationListeners();

                applyFilters(); // Initial render of cards after data load and filters applied

            } catch (error) {
                console.error("Error loading or processing drugs data:", error);
                document.getElementById('app').innerHTML = `<p class="text-xl text-red-500 text-center">Failed to load drug data. Please ensure 'Drugs.json' is in the _data folder and correctly referenced.</p>`;
            }
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
