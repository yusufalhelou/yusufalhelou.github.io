<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Pharmacy Quiz Game</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Test your pharmacy knowledge with this fun and interactive Community Pharmacy Quiz game! Answer patient questions, earn points, and become the best pharmacist.">
    <meta name="keywords" content="pharmacy game, quiz game, pharmacist, medical quiz, educational game, community pharmacy, healthcare, patient care">
    <meta name="author" content="Yusuf Muhsin Alhelou">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook / LinkedIn Meta Tags -->
    <meta property="og:title" content="Community Pharmacy Quiz Game">
    <meta property="og:description" content="Test your pharmacy knowledge with this fun and interactive Community Pharmacy Quiz game! Answer patient questions, earn points, and become the best pharmacist.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.yusufalhelou.com/game"> 
    <meta property="og:image" content="https://raw.githubusercontent.com/yusufalhelou/yusufalhelou.github.io/main/assets/game/welcometothepharmacyresized.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Community Pharmacy Quiz Game">
    <meta name="twitter:description" content="Test your pharmacy knowledge with this fun and interactive Community Pharmacy Quiz game! Answer patient questions, earn points, and become the best pharmacist.">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/yusufalhelou/yusufalhelou.github.io/main/assets/game/welcometothepharmacyresized.png"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- New: Arabic Font - Handjet -->
    <link href="https://fonts.googleapis.com/css2?family=Handjet:wght@500;700&display=swap" rel="stylesheet">
    <style>
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-15px);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* New: Shimmer animation for loading text */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-bounce {
            animation: bounce 1.5s infinite;
        }

        .animate-shine {
            animation: shine 1.5s infinite;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #333;
            color: #fff;
            overflow: hidden;
        }
        .pixel-border {
            border: 4px solid #000;
            box-shadow:
                4px 4px 0 #000,
                -4px -4px 0 #000,
                -4px 4px 0 #000,
                4px -4px 0 #000;
        }
        .pixel-button {
            background-color: #4CAF50;
            border: 4px solid #000;
            box-shadow:
                4px 4px 0 #000;
            transition: all 0.1s ease-in-out;
            image-rendering: pixelated;
        }
        .pixel-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
		
        .patient-bubble {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 12px;
            border: 4px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.2s linear;
            z-index: 10;
            min-width: 120px;
            text-align: center;

            max-width: 80%;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            box-sizing: border-box;
        }
        .patient-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 12px solid #000;
        }
        .patient-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
            z-index: 11;
        }
        .patient.active .patient-bubble {
            visibility: visible;
            opacity: 1;
        }
        .patience-bar {
            width: 80px;
            height: 8px;
            background-color: #555;
            border: 2px solid #000;
            margin: 4px auto 0;
			z-index: 3;
        }
        .patience-bar-inner {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.2s linear;
        }
        #modal-overlay, #question-answer-modal, #feedback-modal-overlay, #search-modal-overlay, #leaderboard-modal-overlay, #name-input-modal-overlay {
            background-color: rgba(0,0,0,0.7);
        }
        #feedback-modal, #leaderboard-modal, #name-input-modal {
            padding: 20px;
            font-size: 2em;
            font-weight: bold;
            border-radius: 10px;
            color: white;
            text-shadow: 2px 2px 0 #000;
            /* Added flex for internal alignment of feedback text and skip button */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .correct {
            background-color: #28a745; /* Green */
        }
        .incorrect {
            background-color: #dc3545; /* Red */
        }

        #question-text {
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            text-align: center;
            padding: 0 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        #answer-choices {
            max-height: 60vh;
            overflow-y: auto;
        }
        #answer-choices button {
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            text-align: center;
            box-sizing: border-box;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.8em;
            line-height: 1.4;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #555; /* Darker track */
            border: 2px solid #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #4CAF50; /* Green thumb */
            border: 2px solid #000;
            border-radius: 0; /* No rounded corners for pixel look */
            box-shadow: 2px 2px 0 #000; /* Pixel-like shadow */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3e8e41; /* Darker green on hover */
        }

        /* For Firefox (less customization options) */
        * {
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #555;
        }

        /* Pharmacy Background Details */
        .pharmacy-wall {
            background-color: #E0F2F7; /* Light sky blue */
        }
        .shelf {
            background-color: #B0C4DE; /* Light steel blue (metallic greyish-blue) */
            border: 2px solid #000;
            box-shadow: 2px 2px 0 #000;
            position: absolute;
            left: 5%;
            right: 5%;
            height: 16px; /* Pixel height for shelves */
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 2px 0;
            z-index: 1;
        }
        .shelf-item {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            box-shadow: 1px 1px 0 #000;

        }
        /* More pharmacy-like product colors for cool tones */
        .product-light-blue { background-color: #A7D9E0; } /* Desaturated light blue */
        .product-light-green { background-color: #C0E6E0; } /* Desaturated light green */
        .product-light-pink { background-color: #A7D0E0; } /* Another desaturated light blue/cyan */
        .product-light-yellow { background-color: #C7E0E0; } /* Very light bluish-grey */


        /* Pharmacy Counter Details */
        .pharmacy-counter-top {
            width: 100%;
            height: 24px;
            background-color: #F0F0F0; /* Clean white for counter top */
            border-top: 4px solid #000;
            box-shadow: 0 -4px 0 #000;
            position: absolute;
            bottom: 452px; /* Adjusted from 352px for the new 700px height */
            left: 0;
            right: 0;
            z-index: 3;
        }
        .counter-detail {
            position: absolute;
            bottom: 4px;
            left: 600px; /* Adjusted to make room for left computer */
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 4;
        }
        .cash-register, .computer-screen-right { /* Renamed for clarity */
            background-color: #333;
            border: 2px solid #000;
            box-shadow: 2px 2px 0 #000;
            position: relative;
        }
        .cash-register {
            width: 40px;
            height: 32px;
            border-bottom: 8px solid #000;
        }
        .computer-screen-right { /* Renamed for clarity */
            width: 48px;
            height: 36px;
        }
        .screen-display {
            background-color: #7FFF00; /* Neon green for screen */
            width: 80%;
            height: 60%;
            position: absolute;
            top: 10%;
            left: 10%;
            border: 1px solid #000;
        }

        /* Pixel Art Clock */
        .pixel-clock {
            position: absolute;
            top: 60px; /* Adjusted position to move it down */
            right: 20px;
            background-color: #000;
            color: #7FFF00; /* Neon green for digits */
            padding: 6px 10px;
            border: 4px solid #000;
            box-shadow: 4px 4px 0 #000;
            font-size: 1em;
            line-height: 1;
            letter-spacing: 2px;
            text-shadow: 1px 1px 0 #000;
            z-index: 5; /* Ensure it's on top */
        }

        /* New Left Computer Styling */
        .computer-left {
            position: absolute;
            bottom: 6px; /* This is the bottom of the counter-top div */
            left: 40px; /* Adjusted left position to be near score and clearly visible */
            width: 48px;
            height: 36px;
            background-color: #333;
            border: 2px solid #000;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
            z-index: 3; /* Same as other counter details */
        }
        .computer-left .screen-display {
            background-color: #ADD8E6; /* Light blue for lofi screen */
        }

        /* Search Button */
        #search-button {
            position: absolute;
            top: 20px; /* Adjust as needed within the modal */
            left: 10px; /* Adjust as needed within the modal */
            background-color: #f0f0f0; /* Match modal background */
            border: 2px solid #000;
            padding: 6px;
            cursor: pointer;
            z-index: 4; /* Above answer choices */
            box-shadow: 2px 2px 0 #000;
            display: none; /* Hidden by default */
        }
        #search-button:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* Search Icon SVG (simple pixel-art style) */
        #search-button svg {
            width: 24px;
            height: 24px;
            display: block;
        }
        #search-button svg path {
            fill: #000;
        }

        /* Search Modal Overlay */
        #search-modal-overlay {
            position: absolute;
            inset: 0;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 40; /* Higher than other modals */
        }

        #search-modal {
            background-color: #f0f0f0;
            color: black;
            padding: 20px;
            text-align: center;
            pixel-border; /* Re-use pixel border style */
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        #search-modal .close-button, #name-input-modal .close-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            color: #000;
            padding: 4px;
            line-height: 1;
            image-rendering: pixelated;
        }
		
		#leaderboard-modal .close-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            color: #000;
            padding: 4px;
            line-height: 1;
            image-rendering: pixelated;
        }
		
        #search-modal .close-button:hover, #leaderboard-modal .close-button:hover, #name-input-modal .close-button:hover {
            color: #e74c3c;
        }

        #google-logo-pixel {
            width: 100px; /* Adjust size as needed */
            height: 30px; /* Adjust size as needed */
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 0; /* Hide font size for pixel art */
        }

        /* Google Logo Pixel Art using divs */
        #google-logo-pixel .g-pixel { background-color: #4285F4; } /* Blue */
        #google-logo-pixel .o-pixel { background-color: #EA4335; } /* Red */
        #google-logo-pixel .o2-pixel { background-color: #FBBC05; } /* Yellow */
        #google-logo-pixel .g2-pixel { background-color: #4285F4; } /* Blue */
        #google-logo-pixel .l-pixel { background-color: #34A853; } /* Green */
        #google-logo-pixel .e-pixel { background-color: #EA4335; } /* Red */

        /* A simple pixelated 'G' */
        #google-logo-pixel div:nth-child(1) { /* G */
            width: 15px; height: 15px;
            background:
                linear-gradient(to right, #4285F4 33%, transparent 33%) 0 0 / 100% 5px,
                linear-gradient(to right, #4285F4 33%, transparent 33%) 0 10px / 100% 5px,
                linear-gradient(to top, #4285F4 33%, transparent 33%) 0 0 / 5px 100%,
                linear-gradient(to top, #4285F4 33%, transparent 33%) 10px 5px / 5px 100%;
            background-repeat: no-repeat;
            position: relative;
        }
        #google-logo-pixel div:nth-child(1)::after {
            content: '';
            position: absolute;
            top: 5px; right: 0; width: 5px; height: 5px; background-color: #EA4335; /* Orange dot for G */
        }

        /* Simple circles for 'o' */
        #google-logo-pixel div:nth-child(2),
        #google-logo-pixel div:nth-child(3) { /* o, o */
            width: 15px; height: 15px;
            border: 4px solid;
            border-color: #EA4335; /* Red for first o */
            border-radius: 50%;
            box-sizing: border-box;
            position: relative;
        }
        #google-logo-pixel div:nth-child(3) {
            border-color: #FBBC05; /* Yellow for second o */
        }

        /* Another pixelated 'g' */
        #google-logo-pixel div:nth-child(4) { /* g */
            width: 15px; height: 15px;
            background:
                linear-gradient(to right, #4285F4 33%, transparent 33%) 0 0 / 100% 5px,
                linear-gradient(to right, #4285F4 33%, transparent 33%) 0 10px / 100% 5px,
                linear-gradient(to top, #4285F4 33%, transparent 33%) 0 0 / 5px 100%,
                linear-gradient(to top, #4285F4 33%, transparent 33%) 10px 5px / 5px 100%;
            background-repeat: no-repeat;
            position: relative;
        }
        #google-logo-pixel div:nth-child(4)::after {
            content: '';
            position: absolute;
            top: 5px; right: 0; width: 5px; height: 5px; background-color: #EA4335; /* Orange dot for G */
        }


        /* Simple 'l' */
        #google-logo-pixel div:nth-child(5) { /* l */
            width: 5px; height: 15px; background-color: #34A853; /* Green */
            position: relative;
        }

        /* Simple 'e' */
        #google-logo-pixel div:nth-child(6) { /* e */
            width: 15px; height: 15px;
            background:
                linear-gradient(to right, #EA4335 100%, transparent 100%) 0 0 / 100% 5px,
                linear-gradient(to right, #EA4335 100%, transparent 100%) 0 5px / 100% 5px,
                linear-gradient(to right, #EA4335 100%, transparent 100%) 0 10px / 100% 5px,
                linear-gradient(to top, #EA4335 100%, transparent 100%) 0 0 / 5px 100%;
            background-repeat: no-repeat;
            position: relative;
        }

        #google-logo-pixel > div { margin: 0 2px; } /* Spacing between letters */

        #search-input-container {
            display: flex;
            align-items: center;
            border: 2px solid #000;
            background-color: white;
            padding: 5px;
            margin-bottom: 15px;
        }
        #search-input {
            flex-grow: 1;
            border: none;
            outline: none;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7em;
            padding: 5px;
            background-color: transparent;
            color: black;
        }
        #search-input-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px;
        }
        #search-input-button svg {
            width: 20px;
            height: 20px;
        }
        #search-input-button svg path {
            fill: #000;
        }
		#patient-area {
            z-index: 2; /* a value greater than the shelves */
        }

         /* Leaderboard Modal Styles */
        #leaderboard-modal-overlay {
            position: absolute;
            inset: 0;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 35; /* Between game modals and search modal */
        }

        #leaderboard-modal {
            background-color: #f0f0f0;
            color: black;
            padding: 20px;
            text-align: center;
            pixel-border;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        #leaderboard-modal h2 {
            font-family: 'Press Start 2P', cursive; /* Default for English */
            font-size: 0.8em; /* Default font size */
            margin-bottom: 15px;
            color: #4CAF50; /* Green title */
            text-shadow: 1px 1px 0 #000;
        }


        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 1.5em;
        }

        #leaderboard-list li {
            background-color: #e0e0e0;
            border: 2px solid #000;
            padding: 8px 10px;
            margin-bottom: 5px;
            display: flex; /* This is key for side-by-side content */
            justify-content: space-between; /* Pushes first child left, second child right */
            align-items: center;
            box-shadow: 2px 2px 0 #000;
        }

        #leaderboard-list li span {
            font-weight: bold;
            /* Apply Handjet to ALL player names */
            font-family: 'Handjet', cursive;
            font-size: 0.8em; /* Adjusted for better Handjet readability */
			padding: 0px 5px;
			text-shadow: 1px 1px 0 #555;
        }
        
        /* New: Styles for loading text shimmer */
        .loading-text-shimmer {
            color: transparent !important; /* Hide text */
            background-color: #d0d0d0; /* Base color for shimmer */
            background: linear-gradient(100deg, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 80%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            min-width: 80px; /* Ensure some visible width */
            height: 1.2em; /* Match line height for visual consistency */
            display: inline-block; /* Essential for background to apply */
            border-radius: 4px; /* Slight rounding for loading blocks */
            vertical-align: middle; /* Align with other content */
        }

        #leaderboard-list li:nth-child(odd) {
            background-color: #d0d0d0; /* Alternate row color */
        }

        #leaderboard-list li:first-child {
            background-color: #FFD700; /* Gold for 1st place */
            color: #000;
            font-size: 1em;
            padding: 10px 15px;
            text-shadow: 1px 1px 0 #555;
        }
        #leaderboard-list li:nth-child(2) {
            background-color: #C0C0C0; /* Silver for 2nd place */
            color: #000;
            font-size: 0.95em;
            padding: 9px 14px;
            text-shadow: 1px 1px 0 #555;
        }
        #leaderboard-list li:nth-child(3) {
            background-color: #CD7F32; /* Bronze for 3rd place */
            color: #000;
            font-size: 0.9em;
            padding: 8px 13px;
            text-shadow: 1px 1px 0 #555;
        }

        /* New style for the alias under 'سونيك' */
        .owner-alias {
            font-size: 0.8rem; /* Very small */
            color: #007bff; /* Sonic blue color */
            margin-top: 2px; /* Small spacing below the main name */
            direction: ltr; /* Ensure LTR for the alias text */
            text-align: left; /* Ensure left alignment */
            font-family: 'Press Start 2P', cursive; /* Pixel font for the alias */
        }

        /* New style for player avatar images */
        .player-avatar {
            width: 100px; /* 1:1 aspect ratio */
            height: 100px; /* 1:1 aspect ratio */
            object-fit: cover; /* Ensures image covers the area without distortion */
            border: 2px solid #4CAF50; /* Green pixel border */
            box-shadow: 2px 2px 0 #000; /* Pixel shadow */
            image-rendering: pixelated; /* Keeps the pixelated look for low-res images */
            flex-shrink: 0; /* Prevents image from shrinking in flex container */
        }

        #leaderboard-modal .pixel-button {
            margin-top: 20px;
        }

        /* Name Input Modal Styles */
        #name-input-modal-overlay {
            position: absolute;
            inset: 0;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 45; /* Highest z-index to be on top of all other modals */
        }

        #name-input-modal {
            background-color: #f0f0f0;
            color: black;
            padding: 20px;
            text-align: center;
            pixel-border;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        #name-input-modal h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
            text-shadow: 1px 1px 0 #AAA;
        }

        #name-input-modal input {
            background-color: white;
            border: 2px solid #000;
            padding: 8px;
            width: calc(100% - 16px);
            margin-bottom: 15px;
            /* Default font for input, will be overridden by [lang="ar"] if Arabic */
            font-family: 'Handjet', cursive;
            font-size: 0.8em;
            color: #000;
            box-shadow: 2px 2px 0 #000;
            outline: none;
            direction: ltr; /* Ensure LTR direction by default */
            text-align: left; /* Ensure left alignment by default */
        }
        
		.pixel-button-two {
            background-color: #af9e4c;
            border: 4px solid #000;
            box-shadow:
                4px 4px 0 #000;
            transition: all 0.1s ease-in-out;
            image-rendering: pixelated;

			animation: color-shift 5s linear infinite;
        }
        .pixel-button-two:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
		
		@keyframes color-shift {
		  0% {
			filter: hue-rotate(0deg);
		  }
		  100% {
			filter: hue-rotate(360deg);
		  }
		}
		
        /* Style for the player count text */
        #player-count-display {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em; /* Smaller text */
            color: #4CAF50; /* Green color to match the leaderboard theme */
            margin-top:10px; /* Small margin above */
            text-shadow: 1px 1px 0 #000;
            /* Added min-height to ensure space is reserved even if content is empty initially */
            min-height: 1.2em; 
            /* Added min-width to ensure some visual presence */
            min-width: 150px; 
        }

		.pixel-border.incorrect {
			max-width: 90%;
		}

    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <div id="game-container" class="relative w-full max-w-4xl h-[700px] bg-[#5c94fc] p-4 overflow-hidden pixel-border">
        <!-- Pharmacy Background -->
        <div class="absolute inset-0 bg-[#E0F2F7]"></div> <!-- Main back wall color: Light sky blue -->

        <!-- Shelves Left -->
        <div class="shelf top-[80px] w-2/5">
            <div class="shelf-item product-light-blue"></div>
            <div class="shelf-item product-light-green"></div>
            <div class="shelf-item product-light-pink"></div>
            <div class="shelf-item product-light-yellow"></div>
        </div>
        <div class="shelf top-[160px] w-2/5">
            <div class="shelf-item product-light-pink"></div>
            <div class="shelf-item product-light-yellow"></div>
            <div class="shelf-item product-light-blue"></div>
            <div class="shelf-item product-light-green"></div>
        </div>

        <!-- Shelves Right -->
        <div class="shelf top-[80px] right-[5%] w-2/5">
            <div class="shelf-item product-light-yellow"></div>
            <div class="shelf-item product-light-blue"></div>
            <div class="shelf-item product-light-green"></div>
            <div class="shelf-item product-light-pink"></div>
        </div>
        <div class="shelf top-[160px] right-[5%] w-2/5">
            <div class="shelf-item product-light-green"></div>
            <div class="shelf-item product-light-pink"></div>
            <div class="shelf-item product-light-yellow"></div>
            <div class="shelf-item product-light-blue"></div>
        </div>

        <!-- Pixel Art Clock -->
        <div id="pixel-clock" class="pixel-clock"></div>

        <!-- UI -->
        <div class="absolute top-4 left-4 text-lg">Score: <span id="score">0</span></div>
        <button id="stop-button" class="absolute top-4 right-4 pixel-button text-white px-4 py-2 text-sm hidden">Stop Game</button>

        <!-- Pharmacy Counter Background -->
        <div class="absolute bottom-0 left-0 right-0 h-1/2 bg-[#8b5a2b] flex flex-col justify-end z-10">
            <!-- Counter Base -->
            <div class="w-full h-4 bg-[#6a421a] border-b-4 border-black"></div>
            <div class="w-full h-12 bg-[#6a421a] border-t-8 border-black"></div>
        </div>

        <!-- Pharmacy Counter Top (New Layer) -->
        <div class="pharmacy-counter-top">
            <!-- Computer on the left for lofi music -->
            <div id="lofi-computer" class="computer-left">
                <div class="screen-display"></div>
            </div>
            <div class="counter-detail">
                <div class="cash-register">
                    <!-- Simple cash register display/buttons -->
                    <div class="absolute top-2 left-2 w-4 h-4 bg-gray-600 border border-gray-800"></div>
                    <div class="absolute bottom-2 left-2 w-8 h-4 bg-gray-600 border border-gray-800"></div>
                </div>
                <div class="computer-screen-right"> <!-- Renamed for clarity -->
                    <div class="screen-display"></div>
                </div>
            </div>
        </div>

        <!-- Patient Area -->
        <div id="patient-area" class="absolute bottom-[452px] left-1/2 -translate-x-1/2">
             <div id="patient" class="relative w-24 h-32 opacity-0 transition-opacity duration-500">
                <div id="patient-sprite-container"></div>
                <div class="patient-bubble"><span id="patient-bubble-text"></span></div>
             </div>
        </div>

        <!-- Start/Game Over Modal -->
        <div id="modal-overlay" class="absolute inset-0 flex items-center justify-center z-20" style="display: flex; opacity: 1;">
            <div id="modal" class="bg-[#f0f0f0] text-black p-8 text-center pixel-border w-96">
                <h2 id="modal-title" class="text-2xl mb-4">Welcome to the Pharmacy!</h2>
                <p id="modal-text" class="mb-6">Test your pharmacy knowledge! Answer patient questions correctly to earn points. Good luck!</p>
                <p id="final-score" class="text-xl mb-4 hidden"></p>
                <p id="high-score" class="text-lg mb-4 hidden">Highest Score: 0</p>
                <button id="start-button" class="pixel-button text-white px-6 py-3 text-lg">Start Game</button>
                <button id="view-leaderboard-button" class="pixel-button-two text-white px-6 py-3 text-lg mt-4">Top Pharmacists</button> <!-- New Leaderboard button -->
                <div id="player-count-display" class="text-center text-sm mt-2">Loading players...</div> <!-- New: Player count display with initial text -->
            </div>
        </div>

        <!-- Question/Answer Modal -->
        <div id="question-answer-modal" class="absolute inset-0 hidden items-center justify-center z-20">
            <!-- Added max-height and overflow-y to the inner modal content container -->
            <div class="bg-[#f0f0f0] text-black p-4 sm:p-8 text-center pixel-border w-full mx-4 sm:w-3/4 md:w-2/3 lg:w-1/2 max-h-[85vh] overflow-y-auto">
                <!-- Search Button -->
                <button id="search-button" class="pixel-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" />
                    </svg>
                </button>
                <h2 class="text-xl mb-4" id="question-text"></h2>
                <div id="answer-choices" class="grid grid-cols-1 gap-1 mb-4">
                </div>
                <div id="modal-patience-container" class="w-full px-4 hidden">
                    <div class="text-xs mb-1 text-center">Time remaining:</div>
                    <div class="patience-bar mx-auto">
                        <div class="patience-bar-inner"></div>
                    </div>
                </div>
                    <!-- Answer buttons will be populated here -->
                </div>
            </div>
        </div>

        <!-- Search Modal -->
        <div id="search-modal-overlay" class="absolute inset-0 flex items-center justify-center z-40">
            <div id="search-modal" class="bg-[#f0f0f0] text-black p-8 text-center pixel-border">
                <button class="close-button" id="close-search-modal">X</button>
                <div id="google-logo-pixel" class="flex items-center justify-center">
                    <div class="g-pixel"></div>
                    <div class="o-pixel"></div>
                    <div class="o2-pixel"></div>
                    <div class="g2-pixel"></div>
                    <div class="l-pixel"></div>
                    <div class="e-pixel"></div>
                </div>
                <div id="search-input-container">
                    <input type="text" id="search-input" placeholder="Search Google for a hint..." class="flex-grow">
                    <button id="search-input-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" />
                    </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal-overlay" class="absolute inset-0 flex items-center justify-center z-30">
            <div id="leaderboard-modal" class="bg-[#f0f0f0] text-black p-8 text-center pixel-border">
                <button class="close-button" id="close-leaderboard-modal">X</button>
                <h2>Top Pharmacists</h2>
                <ul id="leaderboard-list" class="list-none p-0 m-0">
                    <!-- Leaderboard items will be inserted here -->
                </ul>
            </div>
        </div>

        <!-- Name Input Modal -->
        <div id="name-input-modal-overlay" class="absolute inset-0 flex items-center justify-center z-45">
            <div id="name-input-modal" class="bg-[#f0f0f0] text-black p-8 text-center pixel-border">
                <h2>Enter Your Name!</h2>
                <p class="text-sm mb-4">Your score: <span id="name-input-score-display">0</span></p>
                <div id="name-input-message" class="text-red-600 text-sm mb-2 hidden"></div> <!-- Added for validation message -->
                <input type="text" id="player-name-input" placeholder="Your Name (max 20 chars)" maxlength="20" class="w-full text-black mb-4">
                <button id="submit-name-button" class="pixel-button text-white px-6 py-3 text-lg">Submit Score</button>
                <button id="cancel-name-button" class="pixel-button text-white bg-gray-500 px-6 py-3 text-lg mt-2">No, Thanks</button>
            </div>
        </div>


        <!-- Feedback Modal (Correct/Incorrect) -->
        <div id="feedback-modal-overlay" class="absolute inset-0 hidden items-center justify-center z-30">
            <div id="feedback-modal" class="pixel-border">
                <span id="feedback-text"></span>
                <p id="correct-answer-text" class="text-base text-white mt-2 hidden"></p>
                <button id="skip-feedback-button" class="pixel-button text-white px-4 py-2 mt-4 text-sm hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block align-middle mr-1">
                        <path fill-rule="evenodd" d="M3.75 12a.75.75 0 01.75-.75h12.546l-1.957-1.957a.75.75 0 011.06-1.06l3.25 3.25a.75.75 0 010 1.06l-3.25 3.25a.75.75 0 11-1.06-1.06l1.957-1.957H4.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                    </svg>
                    Skip
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-[#1a1a2e] z-50 font-[Press+Start+2P]">
        <div class="w-24 h-24 mb-6 bg-center bg-no-repeat bg-contain animate-bounce">
            <!-- New Pixel Art Capsule SVG Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">
                <!-- Outline / Base Shape -->
                <rect x="7" y="5" width="10" height="14" fill="#000000"/>

                <!-- Left half (Darker shade) -->
                <rect x="8" y="6" width="4" height="12" fill="#6A5ACD"/> <!-- Slate Blue -->
                <rect x="9" y="5" width="2" height="1" fill="#6A5ACD"/>
                <rect x="9" y="18" width="2" height="1" fill="#6A5ACD"/>
                <rect x="7" y="7" width="1" height="10" fill="#6A5ACD"/>
                <rect x="6" y="8" width="1" height="8" fill="#6A5ACD"/>
                <rect x="5" y="9" width="1" height="6" fill="#6A5ACD"/>

                <!-- Right half (Lighter shade) -->
                <rect x="12" y="6" width="4" height="12" fill="#8A2BE2"/> <!-- Blue Violet -->
                <rect x="13" y="5" width="2" height="1" fill="#8A2BE2"/>
                <rect x="13" y="18" width="2" height="1" fill="#8A2BE2"/>
                <rect x="16" y="7" width="1" height="10" fill="#8A2BE2"/>
                <rect x="17" y="8" width="1" height="8" fill="#8A2BE2"/>
                <rect x="18" y="9" width="1" height="6" fill="#8A2BE2"/>

                <!-- Division line in the middle -->
                <rect x="11" y="6" width="2" height="12" fill="#000000"/>

                <!-- Small highlight/shine -->
                <rect x="9" y="7" width="1" height="4" fill="#FFFFFF" opacity="0.3"/>
                <rect x="10" y="8" width="1" height="2" fill="#FFFFFF" opacity="0.3"/>
            </svg>
        </div>
        <div class="text-white text-lg mb-4 text-center text-shadow">Dispensing Knowledge...</div>
        <div class="w-64 h-4 bg-gray-700 rounded-full overflow-hidden border-2 border-black">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-green-500 to-green-300 transition-all duration-300 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shine"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        // Import Firestore specific functions: getFirestore, collection, addDoc, query, orderBy, limit, getDocs, where, updateDoc
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        // Use __firebase_config if available in the environment, otherwise use hardcoded
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCKFARdMNaVXmvrvcP4aJPE6TB8LRusfrE",
            authDomain: "welcome-to-the-pharmacy.firebaseapp.com",
            projectId: "welcome-to-the-pharmacy",
            storageBucket: "welcome-to-the-pharmacy.firebaseastorage.app",
            messagingSenderId: "663040590491",
            appId: "1:663040590491:web:2a8fcb645ab893499c3c3e"
        };

        // Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async () => {
            const patientEl = document.getElementById('patient');
            const patientSpriteContainerEl = document.getElementById('patient-sprite-container');
            const patientBubbleTextEl = document.getElementById('patient-bubble-text');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const finalScoreEl = document.getElementById('final-score');
            const highScoreEl = document.getElementById('high-score');
            const startButton = document.getElementById('start-button');
            const questionAnswerModal = document.getElementById('question-answer-modal');
            const questionTextEl = document.getElementById('question-text');
            const answerChoicesEl = document.getElementById('answer-choices');
            const feedbackModalOverlay = document.getElementById('feedback-modal-overlay');
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackTextEl = document.getElementById('feedback-text'); 
            const correctAnswerTextEl = document.getElementById('correct-answer-text');
            const skipFeedbackButton = document.getElementById('skip-feedback-button');
            const pixelClockEl = document.getElementById('pixel-clock');
            const lofiComputerEl = document.getElementById('lofi-computer'); // Lofi computer element

            // New search elements
            const searchButton = document.getElementById('search-button');
            const searchModalOverlay = document.getElementById('search-modal-overlay');
            const closeSearchModalButton = document.getElementById('close-search-modal');
            const searchInput = document.getElementById('search-input');
            const searchInputButton = document.getElementById('search-input-button');
            
            // New Leaderboard elements
            const viewLeaderboardButton = document.getElementById('view-leaderboard-button');
            const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const closeLeaderboardModalButton = document.getElementById('close-leaderboard-modal');
            const leaderboardList = document.getElementById('leaderboard-list');
            const leaderboardTitle = document.querySelector('#leaderboard-modal h2'); // Get leaderboard title

            // New Name Input Modal elements
            const nameInputModalOverlay = document.getElementById('name-input-modal-overlay');
            const nameInputModal = document.getElementById('name-input-modal');
            const playerNameInput = document.getElementById('player-name-input');
            const submitNameButton = document.getElementById('submit-name-button');
            const cancelNameButton = document.getElementById('cancel-name-button');
            const nameInputScoreDisplay = document.getElementById('name-input-score-display');
            const nameInputMessageEl = document.getElementById('name-input-message'); // Added for validation message

            // New: Player Count Display element
            const playerCountDisplayEl = document.getElementById('player-count-display');


            // --- Game State ---
            let score = 0;
            let gameActive = false;
            let currentPatient = null;
            let patientTimer;
            let answeredQuestions = [];
            let highestScore = 0; // This will now primarily be a local fallback/display, real high score is from Firebase
            let feedbackTimeoutId;
            let finalGameScore = 0; // To store the score before asking for name

            // --- Sound Engine (Tone.js) ---
            const synth = new Tone.Synth().toDestination();
            const errorSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0 }
            }).toDestination();
            const successSynth = new Tone.PolySynth(Tone.Synth, {
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 }
            }).toDestination();

            // Lofi Ambient Synth
            const lofiSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 4,    // Slow attack for a soft start
                    decay: 0.5,
                    sustain: 0.8,
                    release: 6    // Long release for fading sound
                },
                volume: -18 // Adjust volume for background
            }).toDestination();
            lofiSynth.set({ detune: -100 }); // Slightly detune for a "wobbly" lofi effect

            let lofiMusicPlaying = false;
            const lofiChords = [
                ["C3", "E3", "G3"],
                ["A2", "C3", "E3"],
                ["F2", "A2", "C3"],
                ["G2", "B2", "D3"]
            ];
            let lofiIntervalId; // To store the interval ID for lofi music


            const playSound = (note, duration) => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                synth.triggerAttackRelease(note, duration);
            };

            // Function to start lofi music
            function startLofiMusic() {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                let currentChordIndex = 0;
                lofiIntervalId = setInterval(() => {
                    lofiSynth.triggerAttackRelease(lofiChords[currentChordIndex], "8m"); // Play chord for 8 measures
                    currentChordIndex = (currentChordIndex + 1) % lofiChords.length;
                }, 8000); // Change chord every 8 seconds (8 measures at assumed tempo)
                lofiMusicPlaying = true;
            }

            // Function to stop lofi music
            function stopLofiMusic() {
                clearInterval(lofiIntervalId);
                lofiSynth.releaseAll(); // Stop any currently playing notes
                lofiMusicPlaying = false;
            }

            // --- Game Config ---
            let ALL_QUESTIONS = [];
            const PATIENT_SPRITES = [
                { body: "#FFDDC1", hair: "#8B4513" }, // Light skin, brown hair
                { body: "#F0C4B1", hair: "#000000" }, // Medium skin, black hair
                { body: "#E0B69F", hair: "#A0522D" }, // Darker skin, reddish-brown hair
                { body: "#C19A6B", hair: "#DAA520" }  // Dark skin, blonde hair
            ];

            // --- Background Audio for game load ---
            const backgroundAudio = new Audio('https://raw.githubusercontent.com/yusufalhelou/yusufalhelou.github.io/main/assets/game/whatsapharmacist.mp3');
            backgroundAudio.volume = 0.7; // Adjust volume as needed

            try {
                // Animate progress bar
                const progressBar = document.getElementById('progress-bar');
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                }, 200);

                const response = await fetch('https://raw.githubusercontent.com/yusufalhelou/yusufalhelou.github.io/main/assets/game/gameconfig.json');
                const fetchedQuestions = await response.json();

                if (Array.isArray(fetchedQuestions)) {
                    ALL_QUESTIONS = fetchedQuestions;
                } else {
                    console.error("gameconfig.json does not contain a valid array of questions.");
                    throw new Error("Invalid game config: gameconfig.json must be an array of questions.");
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    const gameContainer = document.getElementById('game-container');

                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.transition = 'opacity 0.5s ease';

                    setTimeout(async () => { // Made this async to await Tone.start()
                        loadingScreen.style.display = 'none';
                        gameContainer.style.display = 'block';
                        modalOverlay.style.display = 'flex';
                        modalOverlay.style.opacity = '1';

                        // Start Tone.js context and play background audio
                        if (Tone.context.state !== 'running') {
                            await Tone.start();
                        }
                        backgroundAudio.play().catch(e => console.error("Error playing background audio:", e));

                        // Load and display player count on initial load
                        await updatePlayerCountDisplay();

                    }, 500);
                }, 500);
            } catch (error) {
                console.error('Error loading game config:', error);
                const loadingScreen = document.getElementById('loading-screen');
                const gameContainer = document.getElementById('game-container');
                loadingScreen.innerHTML = `
                    <div class="text-white text-lg mb-4 text-center text-shadow">
                        Error loading game. Please check your internet connection.
                        <br><br>Details: ${error.message || error}
                    </div>
                    <button onclick="window.location.reload()" class="pixel-button text-white px-6 py-3 text-lg mt-4">
                        Refresh Page
                    </button>
                `;
                loadingScreen.style.opacity = '1';
                gameContainer.style.display = 'block';
                return;
            }


            // --- Helper Functions ---
            const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];

            const createPatientSprite = (sprite) => {
                const canvas = document.createElement('canvas');
                canvas.width = 24;
                canvas.height = 32;
                canvas.style.imageRendering = 'pixelated';
                canvas.style.width = '96px';
                canvas.style.height = '128px';
                const ctx = canvas.getContext('2d');

                // Head
                ctx.fillStyle = sprite.body;
                ctx.fillRect(8, 0, 8, 8);
                // Hair
                ctx.fillStyle = sprite.hair;
                ctx.fillRect(8, 0, 8, 2);
                // Eyes (simple dots)
                ctx.fillStyle = '#000';
                ctx.fillRect(10, 3, 1, 1);
                ctx.fillRect(13, 3, 1, 1);
                // Mouth (simple smile)
                ctx.fillRect(10, 5, 4, 1);
                // Body with shirt
                const shirtColor = ['#FF5733', '#33A1FF', '#33FF57', '#FF33A1'][Math.floor(Math.random() * 4)];
                ctx.fillStyle = shirtColor;
                ctx.fillRect(4, 8, 16, 16);
                
                // --- Optimized Pixel Art Heart ---
                const heartColors = ['#FF0000', '#FF69B4', '#FF1493', '#00FF00', '#0000FF', '#FFA500'];
                ctx.fillStyle = heartColors[Math.floor(Math.random() * heartColors.length)];
                
                // Draw heart shape using pixels relative to the shirt's top-left corner (4, 8)
                // Center of the shirt is approx x=12, y=16 (relative to canvas)
                const shirtOffsetX = 4;
                const shirtOffsetY = 8;

                // Top "bumps" of the heart
                ctx.fillRect(shirtOffsetX + 5, shirtOffsetY + 3, 2, 1);
                ctx.fillRect(shirtOffsetX + 10, shirtOffsetY + 3, 2, 1);

                // Upper body of the heart
                ctx.fillRect(shirtOffsetX + 4, shirtOffsetY + 4, 3, 1);
                ctx.fillRect(shirtOffsetX + 9, shirtOffsetY + 4, 3, 1);
                
                ctx.fillRect(shirtOffsetX + 3, shirtOffsetY + 5, 11, 1);
                ctx.fillRect(shirtOffsetX + 2, shirtOffsetY + 6, 13, 1);
                ctx.fillRect(shirtOffsetX + 2, shirtOffsetY + 7, 13, 1);
                
                // Middle section
                ctx.fillRect(shirtOffsetX + 3, shirtOffsetY + 8, 11, 1);
                ctx.fillRect(shirtOffsetX + 4, shirtOffsetY + 9, 9, 1);
                ctx.fillRect(shirtOffsetX + 5, shirtOffsetY + 10, 7, 1);
                ctx.fillRect(shirtOffsetX + 6, shirtOffsetY + 11, 5, 1);
                
                // Bottom point
                ctx.fillRect(shirtOffsetX + 7, shirtOffsetY + 12, 3, 1);
                ctx.fillRect(shirtOffsetX + 8, shirtOffsetY + 13, 1, 1);


                // Arms (under shirt sleeves)
                ctx.fillStyle = sprite.body;
                ctx.fillRect(2, 10, 2, 6);
                ctx.fillRect(20, 10, 2, 6);
                // Hands
                ctx.fillStyle = sprite.body;
                ctx.fillRect(2, 16, 2, 2);
                ctx.fillRect(20, 16, 2, 2);
                
                // Shirt collar
                ctx.fillStyle = shirtColor;
                ctx.fillRect(8, 8, 8, 2);
                // Legs
                ctx.fillStyle = sprite.hair; // Using hair color for pants
                ctx.fillRect(6, 24, 4, 8);
                ctx.fillRect(14, 24, 4, 8);
                // Shoes
                ctx.fillStyle = '#333';
                ctx.fillRect(6, 32, 4, 2);
                ctx.fillRect(14, 32, 4, 2);

                return canvas;
            };

            // --- Clock Functionality ---
            function updateClock() {
                const now = new Date();
                let hours = now.getHours();
                let minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';

                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                minutes = minutes < 10 ? '0' + minutes : minutes;

                const strTime = `${hours}:${minutes} ${ampm}`;
                pixelClockEl.textContent = strTime;
            }

            // Update clock initially and then every minute
            updateClock();
            setInterval(updateClock, 60000); // Update every minute


            // --- Game Logic ---
            function spawnPatient() {
                // Reset modal patience bar
                const modalPatienceContainer = document.getElementById('modal-patience-container');
                modalPatienceContainer.classList.remove('hidden');
                const modalPatienceBar = modalPatienceContainer.querySelector('.patience-bar-inner');
                modalPatienceBar.style.width = '100%';
                modalPatienceBar.style.backgroundColor = '#4CAF50';
                if (currentPatient || !gameActive) return;

                let availableQuestions = ALL_QUESTIONS.filter(q => !answeredQuestions.includes(q.id));
                // If all questions have been answered, reset and use all questions again
                if (availableQuestions.length === 0) {
                    answeredQuestions = [];
                    availableQuestions = ALL_QUESTIONS;
                }

                // If there are still no questions (e.g., ALL_QUESTIONS is empty), handle gracefully
                if (availableQuestions.length === 0) {
                    console.error("No questions available to spawn a patient.");
                    gameOver();
                    return;
                }

                const question = getRandomElement(availableQuestions);
                answeredQuestions.push(question.id);

                // Calculate patience based on question length (100ms per character, min 10s, max 30s)
				const readingTime = (question.question.length + question.choices.reduce((sum, c) => sum + c.length, 0)) * 150; // 150ms per character for reading
				const thinkingTime = 7000; // 7-second fixed buffer for thinking
				const totalPatience = readingTime + thinkingTime;
				const patience = Math.min(45000, Math.max(15000, totalPatience));

                currentPatient = {
                    question,
                    patience,
                    startTime: Date.now(),
                };

                patientSpriteContainerEl.innerHTML = '';
                const patientSprite = getRandomElement(PATIENT_SPRITES);
                patientSpriteContainerEl.appendChild(createPatientSprite(patientSprite));

                const patienceBar = document.createElement('div');
                patienceBar.className = 'patience-bar';
                patienceBar.innerHTML = `<div class="patience-bar-inner"></div>`;
                patientSpriteContainerEl.appendChild(patienceBar);

                patientBubbleTextEl.textContent = currentPatient.question.question;

                patientEl.style.opacity = '1';
                patientEl.classList.add('active');

                playSound('C4', '8n');

                patientTimer = setInterval(updatePatience, 100);

                setTimeout(() => openQuestionModal(currentPatient.question), 500);
            }

            function updatePatience() {
                if (!currentPatient) return;
                const elapsedTime = Date.now() - currentPatient.startTime;
                const patienceLeft = 1 - (elapsedTime / currentPatient.patience);

                const barInner = patientEl.querySelector('.patience-bar-inner');
                const modalBarInner = document.querySelector('#modal-patience-container .patience-bar-inner');

                if (barInner) {
                    barInner.style.width = `${Math.max(0, patienceLeft * 100)}%`;
                    modalBarInner.style.width = `${Math.max(0, patienceLeft * 100)}%`;

                    let color;
                    if (patienceLeft < 0.3) color = '#e74c3c';
                    else if (patienceLeft < 0.6) color = '#f1c40f';
                    else color = '#4CAF50';

                    barInner.style.backgroundColor = color;
                    modalBarInner.style.backgroundColor = color;
                }

                if (patienceLeft <= 0) {
                    const correctAnswer = currentPatient.question.choices[currentPatient.question.correctAnswerIndex];
                    patientLeaves(false, "Time's up!", correctAnswer);
                }
            }

            function patientLeaves(success, message = '', correctAnswer = '') {
                document.getElementById('modal-patience-container').classList.add('hidden');
                clearInterval(patientTimer);
                questionAnswerModal.style.display = 'none';
                searchButton.style.display = 'none'; // Hide search button when patient leaves

                showFeedback(success, message, correctAnswer);

                let feedbackDuration;
                if (success) {
                    feedbackDuration = 1500;
                } else {
                    const baseTimeout = 2000;
                    const extraTimePerChar = 100;
                    const answerLength = correctAnswer ? correctAnswer.length : 0;
                    const questionLength = currentPatient.question.question.length;
                    feedbackDuration = baseTimeout + ((answerLength + questionLength) * extraTimePerChar);
                }

                if (feedbackTimeoutId) {
                    clearTimeout(feedbackTimeoutId);
                }

                feedbackTimeoutId = setTimeout(() => {
                    patientEl.style.opacity = '0';
                    patientEl.classList.remove('active');
                    patientBubbleTextEl.textContent = '';
                    feedbackModalOverlay.style.display = 'none';
                    skipFeedbackButton.classList.add('hidden');
                    correctAnswerTextEl.classList.add('hidden');

                    if (!success) {
                        errorSynth.triggerAttackRelease("0.2");
                    } else {
                        successSynth.triggerAttackRelease(["C4", "E4", "G4"], "8n");
                    }

                    currentPatient = null;

                    if (gameActive) {
                        setTimeout(spawnPatient, 2000);
                    } else {
                        gameOver();
                    }
                }, feedbackDuration);
            }

            function showFeedback(isCorrect, message, correctAnswer = '') {
                feedbackTextEl.textContent = message;
                correctAnswerTextEl.classList.add('hidden');

                if (!isCorrect && correctAnswer) {
                    correctAnswerTextEl.textContent = `Correct answer: ${correctAnswer}`;
                    correctAnswerTextEl.classList.remove('hidden');
                    skipFeedbackButton.classList.remove('hidden');
                } else {
                    skipFeedbackButton.classList.add('hidden');
                }

                feedbackModal.className = 'pixel-border ' + (isCorrect ? 'correct' : 'incorrect');
                feedbackModalOverlay.style.display = 'flex';
            }

            function shuffleArrayWithIndex(array, originalCorrectIndex) {
                const shuffled = array.map((value, index) => ({value, originalIndex: index}));
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                const newCorrectIndex = shuffled.findIndex(item => item.originalIndex === originalCorrectIndex);
                return {
                    shuffledChoices: shuffled.map(item => item.value),
                    newCorrectIndex
                };
            }

            function openQuestionModal(question) {
                questionTextEl.textContent = question.question;
                answerChoicesEl.innerHTML = '';
                searchButton.style.display = 'block'; // Show search button when question modal is open

                const {shuffledChoices, newCorrectIndex} = shuffleArrayWithIndex(
                    question.choices,
                    question.correctAnswerIndex
                );

                currentPatient.shuffledCorrectIndex = newCorrectIndex;

                shuffledChoices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'pixel-button text-white px-6 py-3 text-lg';
                    button.textContent = choice;
                    button.addEventListener('click', () => handleAnswer(index));
                    answerChoicesEl.appendChild(button);
                });

                questionAnswerModal.style.display = 'flex';
            }

            function handleAnswer(selectedIndex) {
                if (!currentPatient) return;

                const isCorrect = (selectedIndex === currentPatient.shuffledCorrectIndex);

                if (isCorrect) {
                    score += currentPatient.question.points;
                    updateUI();
                    patientLeaves(true, "Correct!");
                } else {
                    score = Math.max(0, score - (currentPatient.question.points / 2));
                    updateUI();
                    const correctAnswer = currentPatient.question.choices[currentPatient.question.correctAnswerIndex];
                    patientLeaves(false, "Incorrect!", correctAnswer);
                }
            }

            const scoreEl = document.getElementById('score');

            function updateUI() {
                scoreEl.textContent = score;
            }

            // Function to check if a string contains Arabic characters
            function containsArabic(text) {
                // This regex covers most common Arabic Unicode ranges
                const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
                return arabicRegex.test(text);
            }

            // Firebase Integration Functions
            async function saveHighScoreToFirebase(originalPlayerName, currentScore) {
                if (currentScore < 0) return; // Don't save negative scores

                // Normalize the player name to uppercase for consistent storage and querying
                const normalizedPlayerName = originalPlayerName.toUpperCase().replace(/\s/g, ''); // Ensure no spaces

                try {
                    // Query for existing high score for this player using the normalized name
                    const q = query(collection(db, "leaderboard"), where("normalizedPlayerName", "==", normalizedPlayerName), orderBy("score", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        // Player exists, check if new score is higher
                        const existingDoc = querySnapshot.docs[0];
                        const existingScore = existingDoc.data().score;
                        // Retrieve existing imgUrl to preserve it, or set to empty string if not present
                        const existingImgUrl = existingDoc.data().imgUrl || ""; 

                        if (currentScore > existingScore) {
                            // Update existing document if new score is higher
                            await updateDoc(existingDoc.ref, {
                                originalPlayerName: originalPlayerName, // Store the original casing for display
                                normalizedPlayerName: normalizedPlayerName, // CRITICAL: Ensure this is also sent on update
                                score: currentScore,
                                timestamp: new Date(), // Update timestamp for freshness/tie-breaking
                                imgUrl: existingImgUrl // Preserve existing imgUrl
                            });
                            console.log(`Score updated for ${originalPlayerName} (normalized: ${normalizedPlayerName}) to ${currentScore}!`);
                        } else {
                            console.log(`New score ${currentScore} for ${originalPlayerName} (normalized: ${normalizedPlayerName}) is not higher than existing score ${existingScore}. Not updating.`);
                        }
                    } else {
                        // Player does not exist, add a new document
                        await addDoc(collection(db, "leaderboard"), {
                            originalPlayerName: originalPlayerName, // Store the original casing for display
                            normalizedPlayerName: normalizedPlayerName, // Store normalized name for querying
                            score: currentScore,
                            timestamp: new Date(),
                            imgUrl: "" // New field, initially empty
                        });
                        console.log(`New score saved for ${originalPlayerName} (normalized: ${normalizedPlayerName}): ${currentScore}`);
                    }
                    // After saving/updating, refresh the player count display
                    await updatePlayerCountDisplay();

                } catch (e) {
                    console.error("Error saving/updating score to Firebase: ", e);
                }
            }

            async function loadLeaderboardFromFirebase() {
                try {
                    leaderboardList.innerHTML = '<li>Loading scores...</li>'; // Show loading message
                    // Query all scores, sorted as before. We will filter for unique names client-side.
                    // This query needs an index on 'score' (desc) and 'timestamp' (asc)
                    const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), orderBy("timestamp", "asc"));
                    const querySnapshot = await getDocs(q);

                    const uniqueScores = new Map(); // Map to store highest score per normalized player name

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const currentNormalizedName = data.normalizedPlayerName; // Use normalized name for map key

                        // Only add/update if this is the first time we see this normalized name OR
                        // if the current score is higher than what we've already recorded for this normalized name
                        if (!uniqueScores.has(currentNormalizedName) || data.score > uniqueScores.get(currentNormalizedName).score) {
                            uniqueScores.set(currentNormalizedName, { 
                                originalPlayerName: data.originalPlayerName, // Keep original casing for display
                                normalizedPlayerName: data.normalizedPlayerName,
                                score: data.score,
                                timestamp: data.timestamp, // Keep timestamp for tie-breaking if re-sorting
                                imgUrl: data.imgUrl || "" // Retrieve imgUrl, default to empty string
                            });
                        }
                    });
                    
                    // Convert Map values back to an array and sort again to ensure true top 10 unique players
                    // The initial query only gives us documents in a specific order. The uniqueScores map
                    // collects the *highest* score for each unique normalized name. We then need to
                    // re-sort this unique set and slice the top 10.
                    const finalScores = Array.from(uniqueScores.values())
                                        .sort((a, b) => b.score - a.score || a.timestamp.toDate().getTime() - b.timestamp.toDate().getTime())
                                        .slice(0, 10); // Limit to top 10 unique entries

                    displayLeaderboard(finalScores);

                } catch (e) {
                    console.error("Error loading leaderboard from Firebase: ", e);
                    leaderboardList.innerHTML = '<li>Error loading leaderboard.</li>';
                }
            }

            // New function to update the player count display
            async function updatePlayerCountDisplay() {
                playerCountDisplayEl.textContent = "Loading players..."; // Show loading state
                try {
                    // Fetch all documents from the leaderboard collection
                    const querySnapshot = await getDocs(collection(db, "leaderboard"));
                    const uniquePlayers = new Set(); // Use a Set to store unique normalized player names

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.normalizedPlayerName) {
                            uniquePlayers.add(data.normalizedPlayerName);
                        }
                    });

                    playerCountDisplayEl.textContent = `Registered Pharmacists: ${uniquePlayers.size}`;
                } catch (e) {
                    console.error("Error fetching player count:", e);
                    playerCountDisplayEl.textContent = `Error loading player count.`;
                }
            }


            // Function to display leaderboard scores
            function displayLeaderboard(scores) {
                leaderboardList.innerHTML = ''; // Clear existing list

                // Check if the title text itself is Arabic and apply lang attribute
                if (containsArabic(leaderboardTitle.textContent)) {
                    leaderboardTitle.setAttribute('lang', 'ar');
                } else {
                    leaderboardTitle.removeAttribute('lang'); // Ensure it defaults if not Arabic
                }

                if (scores.length === 0) {
                    leaderboardList.innerHTML = '<li>No scores yet! Be the first!</li>';
                    return;
                }

                scores.forEach((entry, index) => {
                    const li = document.createElement('li');
                    
                    // Container for image and player name/alias
                    const playerVisualAndNameContainer = document.createElement('div');
                    playerVisualAndNameContainer.style.display = 'flex';
                    playerVisualAndNameContainer.style.alignItems = 'center';
                    playerVisualAndNameContainer.style.gap = '10px'; // Space between image and text

                    // Add player avatar image if imgUrl exists and is not empty
                    if (entry.imgUrl && entry.imgUrl.trim() !== '') {
                        const playerImage = document.createElement('img');
                        playerImage.src = entry.imgUrl;
                        playerImage.alt = `${entry.originalPlayerName}'s avatar`;
                        playerImage.classList.add('player-avatar'); // Apply new CSS class for 1:1 square
                        playerVisualAndNameContainer.appendChild(playerImage);
                    }

                    // Container for rank, name, and alias
                    const nameAndAliasContainer = document.createElement('div');
                    nameAndAliasContainer.style.display = 'flex';
                    nameAndAliasContainer.style.flexDirection = 'column'; // Stack elements vertically
                    nameAndAliasContainer.style.alignItems = 'flex-start'; // Align text to the left within this container

                    const rankAndNameSpan = document.createElement('span');
                    const rank = (index + 1).toString().padStart(Math.min(3, scores.length.toString().length), '0'); 
                    rankAndNameSpan.textContent = `${rank}. ${entry.originalPlayerName}`;
                    rankAndNameSpan.style.direction = 'ltr'; // Ensure LTR for rank and name
                    rankAndNameSpan.style.textAlign = 'left';
                    rankAndNameSpan.classList.add('loading-text-shimmer'); // Keep shimmer for the name

                    nameAndAliasContainer.appendChild(rankAndNameSpan);

                    // Check if the current player's normalized name matches "سونيك" for special alias
                    const entryNormalizedName = entry.originalPlayerName.toUpperCase().replace(/\s/g, '');
                    if (entryNormalizedName === "سونيك".toUpperCase().replace(/\s/g, '')) {
                        const ownerAlias = document.createElement('div');
                        ownerAlias.classList.add('owner-alias'); // Apply the new styling for alias
                        ownerAlias.textContent = "also: Sonic, Yusuf"; // Custom alias text
                        nameAndAliasContainer.appendChild(ownerAlias); // Append alias under the name
                    }
                    
                    playerVisualAndNameContainer.appendChild(nameAndAliasContainer); // Add name and alias container to the player visual container

                    // Create a separate span for the score
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = entry.score;
                    // The 'justify-content: space-between' on the parent 'li' will naturally push this to the right

                    // Append both main parts to the list item
                    li.appendChild(playerVisualAndNameContainer);
                    li.appendChild(scoreSpan);
                    leaderboardList.appendChild(li);
                });

                // After populating the list, wait for the Handjet font to load and remove shimmer
                document.fonts.ready.then(() => {
                    const nameSpans = leaderboardList.querySelectorAll('li span.loading-text-shimmer');
                    nameSpans.forEach(span => {
                        span.classList.remove('loading-text-shimmer');
                    });
                    const ownerAliases = leaderboardList.querySelectorAll('.owner-alias');
                    ownerAliases.forEach(alias => {
                        alias.style.color = '#007bff'; // Re-apply color in case shimmer hid it
                    });

                }).catch(err => {
                    console.error("Error loading fonts:", err);
                    // Fallback: If font loading fails, ensure text is still visible
                    const nameSpans = leaderboardList.querySelectorAll('li span.loading-text-shimmer');
                    nameSpans.forEach(span => {
                        span.classList.remove('loading-text-shimmer');
                        span.style.color = 'black'; // Ensure text is visible
                    });
                    const ownerAliases = leaderboardList.querySelectorAll('.owner-alias');
                    ownerAliases.forEach(alias => {
                        alias.style.color = '#007bff'; // Ensure it's visible even without Handjet
                    });
                });
            }


            function startGame() {
                score = 0;
                gameActive = true;
                currentPatient = null;
                answeredQuestions = [];
                updateUI();
                finalScoreEl.classList.add('hidden');
                modalOverlay.style.display = 'none';
                stopButton.classList.remove('hidden');
                spawnPatient();
            }

            function gameOver() {
                gameActive = false;
                clearInterval(patientTimer);
                
                // Store the final score before showing the name input modal
                finalGameScore = score; 

                modalTitle.textContent = "Game Over";
                modalText.textContent = "You've completed your shift at the pharmacy. Great job answering all the patient questions!";
                finalScoreEl.textContent = `Final Score: ${finalGameScore}`;
                finalScoreEl.classList.remove('hidden');
                startButton.textContent = "Play Again";
                
                // Hide main modal and show name input modal
                modalOverlay.style.display = 'none';
                showNameInputModal();
                
                loadHighestScore(); // Update local high score display
            }

            // Function to show the custom name input modal
            function showNameInputModal() {
                nameInputScoreDisplay.textContent = finalGameScore; // Display the score
                nameInputModalOverlay.style.display = 'flex';
                playerNameInput.value = ''; // Clear previous input
                nameInputMessageEl.classList.add('hidden'); // Hide any previous error message
                playerNameInput.focus(); // Focus the input field
            }

            // Local highest score logic (can be kept for quick local feedback)
            function loadHighestScore() {
                const storedHighScore = localStorage.getItem('communityPharmacyHighScore');
                if (storedHighScore) {
                    highestScore = parseInt(storedHighScore, 10);
                } else {
                    highestScore = 0;
                }
                highScoreEl.textContent = `Highest Score: ${highestScore}`;
                highScoreEl.classList.remove('hidden');
            }

            function saveHighestScore() {
                // This is now redundant for the main leaderboard but keeps local high score working
                if (score > highestScore) {
                    highestScore = score;
                    localStorage.setItem('communityPharmacyHighScore', highestScore);
                    highScoreEl.textContent = `Highest Score: ${highestScore}`;
                }
            }

            loadHighestScore(); // Load local high score on initial page load

            const stopButton = document.getElementById('stop-button');
            function stopGame() {
                gameActive = false;
                clearInterval(patientTimer);
                if (currentPatient) {
                    patientEl.style.opacity = '0';
                    patientEl.classList.remove('active');
                    patientBubbleTextEl.textContent = '';
                    currentPatient = null;
                }
                questionAnswerModal.style.display = 'none';
                feedbackModalOverlay.style.display = 'none';
                searchModalOverlay.style.display = 'none'; // Close search modal on game stop
                searchButton.style.display = 'none'; // Hide search button on game stop
                stopButton.classList.add('hidden');
                gameOver(); // Call gameOver to handle score saving and modal display
            }

            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            stopButton.addEventListener('click', stopGame);

            // Event listener for the new skip button
            skipFeedbackButton.addEventListener('click', () => {
                if (feedbackTimeoutId) {
                    clearTimeout(feedbackTimeoutId);
                    feedbackTimeoutId = null;
                }
                patientEl.style.opacity = '0';
                patientEl.classList.remove('active');
                patientBubbleTextEl.textContent = '';
                feedbackModalOverlay.style.display = 'none';
                skipFeedbackButton.classList.add('hidden');
                correctAnswerTextEl.classList.add('hidden');

                if (currentPatient && !currentPatient.isCorrect) {
                    errorSynth.triggerAttackRelease("0.2");
                }

                currentPatient = null;

                if (gameActive) {
                    setTimeout(spawnPatient, 2000);
                } else {
                    gameOver();
                }
            });

            // Event listener for the new lofi computer
            lofiComputerEl.addEventListener('click', () => {
                if (lofiMusicPlaying) {
                    stopLofiMusic();
                } else {
                    startLofiMusic();
                }
            });

            // Event listener for Search Button
            searchButton.addEventListener('click', () => {
                questionAnswerModal.style.display = 'none'; // Hide question modal
                searchModalOverlay.style.display = 'flex'; // Show search modal
                searchInput.value = ''; // Clear previous search
                searchInput.focus(); // Focus the input field
            });

            // Event listener for Close Search Modal Button
            closeSearchModalButton.addEventListener('click', () => {
                searchModalOverlay.style.display = 'none'; // Hide search modal
                questionAnswerModal.style.display = 'flex'; // Show question modal again
            });

            // Function to perform Google Search
            function performSearch() {
                const query = searchInput.value.trim();
                if (query) {
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                    searchModalOverlay.style.display = 'none';
                    questionAnswerModal.style.display = 'flex'; // Bring back question
                }
            }

            // Event listener for search input button
            searchInputButton.addEventListener('click', performSearch);

            // Event listener for Enter key in search input
            searchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    performSearch();
                    event.preventDefault(); // Prevent default form submission if any
                }
            });
            
            // Event listener to dynamically apply lang="ar" to the input field if Arabic is typed
            // and ensure LTR for consistency
            playerNameInput.addEventListener('input', () => {
                if (containsArabic(playerNameInput.value)) {
                    playerNameInput.setAttribute('lang', 'ar');
                    // Direction and text-align are now handled by CSS, but good to set them explicitly here
                    playerNameInput.style.direction = 'ltr'; 
                    playerNameInput.style.textAlign = 'left';
                } else {
                    playerNameInput.removeAttribute('lang');
                    playerNameInput.style.direction = 'ltr'; 
                    playerNameInput.style.textAlign = 'left';
                }
            });

            // Define forbidden names (normalized to uppercase, no spaces)
            const FORBIDDEN_NAMES = [
                "YUSUF", "YUSUFALHELOU", "YUSUFMUHSIN", "YUSUF ALHELOU", "YUSUF MUHSIN", "YUSUF MUHSIN ALHELOU", "يوسف الحلو", "SONIC", "القط السوفيتى"
            ].map(name => name.toUpperCase().replace(/\s/g, '')); // Normalize all forbidden names

            // Event listeners for Name Input Modal
            submitNameButton.addEventListener('click', async () => { // Made async to await saveHighScoreToFirebase
                let playerName = playerNameInput.value.trim();
                const normalizedPlayerNameForCheck = playerName.toUpperCase().replace(/\s/g, ''); // Normalize user input for checking

                // Check for forbidden names, but explicitly allow "سونيك"
                if (FORBIDDEN_NAMES.includes(normalizedPlayerNameForCheck) && normalizedPlayerNameForCheck !== "سونيك".toUpperCase().replace(/\s/g, '')) {
                    nameInputMessageEl.textContent = "Sorry, that name is reserved for the game owner! Please choose another.";
                    nameInputMessageEl.classList.remove('hidden');
                    return; // Stop the function here, do not save score
                }

                // If the name is valid, hide any previous error message
                nameInputMessageEl.classList.add('hidden');

                if (playerName === "") {
                    playerName = "Anonymous";
                } else {
                    playerName = playerName.substring(0, 20); // Limit name length
                }
                await saveHighScoreToFirebase(playerName, finalGameScore); // Call updated function, await it
                nameInputModalOverlay.style.display = 'none'; // Hide name input modal
                modalOverlay.style.display = 'flex'; // Show main game modal again
            });

            cancelNameButton.addEventListener('click', () => {
                nameInputModalOverlay.style.display = 'none'; // Hide name input modal
                modalOverlay.style.display = 'flex'; // Show main game modal again
                nameInputMessageEl.classList.add('hidden'); // Hide any error message
                // Do not save score if user cancels
            });


            // Event listener for View Leaderboard Button
            viewLeaderboardButton.addEventListener('click', () => {
                modalOverlay.style.display = 'none'; // Hide main modal
                leaderboardModalOverlay.style.display = 'flex'; // Show leaderboard modal
                loadLeaderboardFromFirebase(); // Load and display scores
            });

            // Event listener for Close Leaderboard Modal Button
            closeLeaderboardModalButton.addEventListener('click', () => {
                leaderboardModalOverlay.style.display = 'none'; // Hide leaderboard modal
                modalOverlay.style.display = 'flex'; // Show main modal again
            });

            updatePlayerCountDisplay();

        });
    </script>
</body>
</html>
